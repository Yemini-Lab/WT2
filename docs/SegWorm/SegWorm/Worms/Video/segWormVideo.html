<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of segWormVideo</title>
  <meta name="keywords" content="segWormVideo">
  <meta name="description" content="SEGWORMVIDEO Segment a worm video.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # SegWorm --><!-- # Worms --><!-- menu.html Video -->
<h1>segWormVideo
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>SEGWORMVIDEO Segment a worm video.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function failedFrames = segWormVideo(videoFile, anglesVideoFile,touchVideoFile, debugVideoFile, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">SEGWORMVIDEO Segment a worm video.

   - Segment the video:
   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,
                               DEBUGVIDEOFILE)

   - Segment the video and normalize the worm:
   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,
                               DEBUGVIDEOFILE, SAMPLES)

   - Segment the video, normalize the worm, then interpolate the worm:
   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,
                               DEBUGVIDEOFILE, SAMPLES, ISINTERP)

   - Segment the video, normalize the worm, then interpolate the worm, and
     exclude stage movements:
   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,
                               DEBUGVIDEOFILE, SAMPLES, ISINTERP,
                               INFOFILE, LOGFILE, DIFFFILE)

   Inputs:
       videoFile       - the name of the video to segment
       anglesVideoFile - the name for the video of the worm's angles;
                         if empty, this video is not created
       touchVideoFile  - the name for the video of the worm's touching
                         segments; if empty, this video is not created
       debugVideoFile  - the name for the video of debugging information;
                         if empty, this video is not created
       samples         - the number of samples to use;
                         if empty, all the worm is used.
       isInterp        - when downsampling, should we interpolate the
                         missing data or copy it from the original worm;
                         if empty, we interpolate the missing data.
       infoFile        - the XML file with the experiment information
                         Note: if infoFile, logFile, and diffFile are
                         undefined, all video frames are segmented
                         (including those containing stage movements)
       logFile         - the CSV file with the stage locations
       diffFile        - the MAT file with the video differentiation

   Outputs:
       failedFrames - the frame numbers at which segmentation failed

   See also <a href="segWormFrames.html" class="code" title="function [worms imgs oImgs] = segWormFrames(videoFile, frames, verbose,varargin)">SEGWORMFRAMES</a>, SEGWORM, <a href="overlayWormAngles.html" class="code" title="function oImg = overlayWormAngles(img, worm, cRGB360, sRGB360, sRGBNaN,headPattern, headRGB, isHeadOpaque, vulvaPattern, vulvaRGB, isVulvaOpaque)">OVERLAYWORMANGLES</a>, <a href="overlayWormTouch.html" class="code" title="function oImg = overlayWormTouch(img, worm, headRGB, isHeadOpaque,tailRGB, isTailOpaque, vulvaRGB, isVulvaOpaque, nonVulvaRGB, isNonVulvaOpaque,cTouchRGB, isCTouchOpaque, cInRGB, isCInOpaque, cOutRGB, isCOutOpaque,sTouchRGB, isSTouchOpaque, sInRGB, isSInOpaque, sOutRGB, isSOutOpaque,sInOutRGB, isSInOutOpaque)">OVERLAYWORMTOUCH</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../SegWorm/Worms/Orientation/flipWormHead.html" class="code" title="function worm = flipWormHead(worm)">flipWormHead</a>	FLIPWORMHEAD Flip the head-to-tail orientation of the worm.</li><li><a href="../../../SegWorm/Worms/Orientation/flipWormVulva.html" class="code" title="function worm = flipWormVulva(worm)">flipWormVulva</a>	FLIPWORMVULVA Flip the vulval orientation of the worm.</li><li><a href="../../../SegWorm/Worms/Orientation/headTailMovementConfidence.html" class="code" title="function [headOrthoConfidence tailOrthoConfidenceheadParaConfidence tailParaConfidenceheadMagConfidence tailMagConfidence] =headTailMovementConfidence(worm1, worm2, varargin)">headTailMovementConfidence</a>	HEADTAILMOVEMENTCONFIDENCE How much confidence do we have in the head and</li><li><a href="../../../SegWorm/Worms/Orientation/orientWorm.html" class="code" title="function [worm2 confidence flippedConfidence] =orientWorm(worm1, worm2, samples, varargin)">orientWorm</a>	ORIENTWORM Orient worm2 to match worm1's orientation (by setting</li><li><a href="../../../SegWorm/Worms/Orientation/orientWormAtCentroid.html" class="code" title="function [worm2 confidence flippedConfidence] =orientWormAtCentroid(worm1, worm2, samples, varargin)">orientWormAtCentroid</a>	ORIENTWORMATCENTROID Orient worm2 to match worm1's orientation (by setting</li><li><a href="../../../SegWorm/Worms/Segmentation/segWorm.html" class="code" title="function worm = segWorm(img, frame, isNormalized, verbose, varargin)">segWorm</a>	SEGWORM Segment the worm in an image and organize the information in a</li><li><a href="../../../SegWorm/Worms/StageMovement/findStageMovement.html" class="code" title="function [frames movesI locations] =findStageMovement(infoFile, logFile, diffFile, verbose, varargin)">findStageMovement</a>	FINDSTAGEMOVEMENT Find stage movements in a worm experiment.</li><li><a href="../../../SegWorm/Worms/StageMovement/readPixels2Microns.html" class="code" title="function [pixel2MicronScale rotation] = readPixels2Microns(infoFile)">readPixels2Microns</a>	READPIXELS2MICRONS Read the experiment information file and compute the</li><li><a href="../../../SegWorm/Worms/Util/norm2Worm.html" class="code" title="function worm = norm2Worm(frame, vulvaContour, nonVulvaContour,skeleton, skeletonAngles, inOutTouch, skeletonLength, widths,headArea, tailArea, vulvaArea, nonVulvaArea,origin, pixel2MicronScale, rotation, worm)">norm2Worm</a>	NORM2WORM Convert normalized worm information into a worm structure.</li><li><a href="../../../SegWorm/Worms/Util/normWorms.html" class="code" title="function [vulvaContours nonVulvaContours skeletons angles inOutToucheslengths widths headAreas tailAreas vulvaAreas nonVulvaAreas isNormed] =normWorms(worms, samples, moves, origins, pixel2MicronScale,rotation, verbose)">normWorms</a>	NORMWORMS Normalize the worms' information to a standard, compact set.</li><li><a href="overlayBadWorm.html" class="code" title="function oImg = overlayBadWorm(img, type)">overlayBadWorm</a>	OVERLAYBADWORM Overlay a bad worm segmentation onto an image.</li><li><a href="overlayWormAngles.html" class="code" title="function oImg = overlayWormAngles(img, worm, cRGB360, sRGB360, sRGBNaN,headPattern, headRGB, isHeadOpaque, vulvaPattern, vulvaRGB, isVulvaOpaque)">overlayWormAngles</a>	OVERLAYWORMANGLES Overlay the worm's contour/skeleton angles (curvature)</li><li><a href="overlayWormTouch.html" class="code" title="function oImg = overlayWormTouch(img, worm, headRGB, isHeadOpaque,tailRGB, isTailOpaque, vulvaRGB, isVulvaOpaque, nonVulvaRGB, isNonVulvaOpaque,cTouchRGB, isCTouchOpaque, cInRGB, isCInOpaque, cOutRGB, isCOutOpaque,sTouchRGB, isSTouchOpaque, sInRGB, isSInOpaque, sOutRGB, isSOutOpaque,sInOutRGB, isSInOutOpaque)">overlayWormTouch</a>	OVERLAYWORMTOUCH Overlay the worm's contour/skeleton touching/inner/outer</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function failedFrames = segWormVideo(videoFile, anglesVideoFile, </a><span class="keyword">...</span>
0002     touchVideoFile, debugVideoFile, varargin)
0003 <span class="comment">%SEGWORMVIDEO Segment a worm video.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   - Segment the video:</span>
0006 <span class="comment">%   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,</span>
0007 <span class="comment">%                               DEBUGVIDEOFILE)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%   - Segment the video and normalize the worm:</span>
0010 <span class="comment">%   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,</span>
0011 <span class="comment">%                               DEBUGVIDEOFILE, SAMPLES)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%   - Segment the video, normalize the worm, then interpolate the worm:</span>
0014 <span class="comment">%   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,</span>
0015 <span class="comment">%                               DEBUGVIDEOFILE, SAMPLES, ISINTERP)</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   - Segment the video, normalize the worm, then interpolate the worm, and</span>
0018 <span class="comment">%     exclude stage movements:</span>
0019 <span class="comment">%   FAILEDFRAMES = SEGWORMVIDEO(VIDEOFILE, ANGLESVIDEOFILE, TOUCHVIDEOFILE,</span>
0020 <span class="comment">%                               DEBUGVIDEOFILE, SAMPLES, ISINTERP,</span>
0021 <span class="comment">%                               INFOFILE, LOGFILE, DIFFFILE)</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%   Inputs:</span>
0024 <span class="comment">%       videoFile       - the name of the video to segment</span>
0025 <span class="comment">%       anglesVideoFile - the name for the video of the worm's angles;</span>
0026 <span class="comment">%                         if empty, this video is not created</span>
0027 <span class="comment">%       touchVideoFile  - the name for the video of the worm's touching</span>
0028 <span class="comment">%                         segments; if empty, this video is not created</span>
0029 <span class="comment">%       debugVideoFile  - the name for the video of debugging information;</span>
0030 <span class="comment">%                         if empty, this video is not created</span>
0031 <span class="comment">%       samples         - the number of samples to use;</span>
0032 <span class="comment">%                         if empty, all the worm is used.</span>
0033 <span class="comment">%       isInterp        - when downsampling, should we interpolate the</span>
0034 <span class="comment">%                         missing data or copy it from the original worm;</span>
0035 <span class="comment">%                         if empty, we interpolate the missing data.</span>
0036 <span class="comment">%       infoFile        - the XML file with the experiment information</span>
0037 <span class="comment">%                         Note: if infoFile, logFile, and diffFile are</span>
0038 <span class="comment">%                         undefined, all video frames are segmented</span>
0039 <span class="comment">%                         (including those containing stage movements)</span>
0040 <span class="comment">%       logFile         - the CSV file with the stage locations</span>
0041 <span class="comment">%       diffFile        - the MAT file with the video differentiation</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%   Outputs:</span>
0044 <span class="comment">%       failedFrames - the frame numbers at which segmentation failed</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%   See also SEGWORMFRAMES, SEGWORM, OVERLAYWORMANGLES, OVERLAYWORMTOUCH</span>
0047 
0048 <span class="comment">% Are we downsampling the worm?</span>
0049 <span class="keyword">if</span> ~isempty(varargin)
0050     downSamples = varargin{1};
0051     
0052     <span class="comment">% Setup the stage movements.</span>
0053     moves = [0, 0];
0054     origins = [0,0];
0055     pixel2MicronScale = [-1, -1];
0056     rotation = 1;
0057 <span class="keyword">else</span>
0058     downSamples = [];
0059 <span class="keyword">end</span>
0060 
0061 <span class="comment">% When downsampling, are we interpolating the missing data or copying it</span>
0062 <span class="comment">% from the original worm?</span>
0063 <span class="keyword">if</span> length(varargin) &gt; 1
0064     isInterp = varargin{2};
0065 <span class="keyword">else</span>
0066     isInterp = true;
0067 <span class="keyword">end</span>
0068 
0069 <span class="comment">% Are we excluding stage movement frames?</span>
0070 moveFrames = [];
0071 <span class="keyword">if</span> length(varargin) == 5
0072     
0073     <span class="comment">% Assign the variable input arguments.</span>
0074     infoFile = varargin{3};
0075     logFile = varargin{4};
0076     diffFile = varargin{5};
0077     
0078     <span class="comment">% Read the info to convert onscreen pixels to real-world microns.</span>
0079     [pixel2MicronScale rotation] = <a href="../../../SegWorm/Worms/StageMovement/readPixels2Microns.html" class="code" title="function [pixel2MicronScale rotation] = readPixels2Microns(infoFile)">readPixels2Microns</a>(infoFile);
0080     
0081     <span class="comment">% Find the stage movements.</span>
0082     [moveFrames, ~, ~] = <a href="../../../SegWorm/Worms/StageMovement/findStageMovement.html" class="code" title="function [frames movesI locations] =findStageMovement(infoFile, logFile, diffFile, verbose, varargin)">findStageMovement</a>(infoFile, logFile, diffFile, 0);
0083 <span class="keyword">end</span>
0084 
0085 <span class="comment">% Open the video and get its information.</span>
0086 <span class="keyword">if</span> ispc()
0087     vr = videoReader(videoFile, <span class="string">'plugin'</span>, <span class="string">'DirectShow'</span>);
0088 <span class="keyword">else</span>
0089     vr = videoReader(videoFile, <span class="string">'plugin'</span>, <span class="string">'ffmpegDirect'</span>);
0090 <span class="keyword">end</span>
0091 fps = get(vr, <span class="string">'fps'</span>);
0092 spf = 1 / fps;
0093 frames = get(vr, <span class="string">'numFrames'</span>) + get(vr, <span class="string">'nHiddenFinalFrames'</span>);
0094 
0095 <span class="comment">% Get the vignette.</span>
0096 vImg = [];
0097 vignetteFile = strrep(videoFile, <span class="string">'.avi'</span>, <span class="string">'.info.xml.vignette.dat'</span>);
0098 <span class="keyword">if</span> exist(vignetteFile, <span class="string">'file'</span>)
0099     height = get(vr, <span class="string">'height'</span>);
0100     width = get(vr, <span class="string">'width'</span>);
0101     fid = fopen(vignetteFile, <span class="string">'r'</span>);
0102     vImg = fread(fid, [width height], <span class="string">'int32=&gt;int8'</span>, 0, <span class="string">'b'</span>)';
0103     fclose(fid);
0104 <span class="keyword">end</span>
0105 
0106 <span class="comment">% Are we making a video showing the worm's angles (curvature)?</span>
0107 isVideo = false;
0108 <span class="keyword">if</span> ~isempty(anglesVideoFile)
0109     isVideo = true;
0110     
0111     <span class="comment">% Construct a pattern to identify the head.</span>
0112     ahImg = [1 1 1 1 1; <span class="keyword">...</span>
0113             1 1 1 1 1; <span class="keyword">...</span>
0114             1 1 1 1 1; <span class="keyword">...</span>
0115             1 1 1 1 1; <span class="keyword">...</span>
0116             1 1 1 1 1];
0117     [ahPattern(:,1) ahPattern(:,2)] = find(ahImg == 1);
0118     ahPattern(:,1) = ahPattern(:,1) - ceil(size(ahImg, 1) / 2);
0119     ahPattern(:,2) = ahPattern(:,2) - ceil(size(ahImg, 2) / 2);
0120     
0121     <span class="comment">% Construct a pattern to identify the vulva.</span>
0122     avImg = [1 1 1 1 1; <span class="keyword">...</span>
0123             1 1 1 1 1; <span class="keyword">...</span>
0124             1 1 1 1 1; <span class="keyword">...</span>
0125             1 1 1 1 1; <span class="keyword">...</span>
0126             1 1 1 1 1];
0127     [avPattern(:,1) avPattern(:,2)] = find(avImg == 1);
0128     avPattern(:,1) = avPattern(:,1) - ceil(size(avImg, 1) / 2);
0129     avPattern(:,2) = avPattern(:,2) - ceil(size(avImg, 2) / 2);
0130     
0131     <span class="comment">% Choose the color scheme.</span>
0132     blue = zeros(360, 3);
0133     blue(:,3) = 255;
0134     red = zeros(360, 3);
0135     red(:,1) = 255;
0136     acRGB = [blue(1:90,:); jet(181) * 255; red(1:90,:)]; <span class="comment">% thermal</span>
0137     asRGB = acRGB;
0138     <span class="comment">%asRGB = [blue(1:90,:); jet(181) * 255; red(1:90,:)]; % thermal</span>
0139     asRGBNaN = [255 0 0]; <span class="comment">% red</span>
0140     ahRGB = [0 255 0]; <span class="comment">% green</span>
0141     isAHOpaque = 1;
0142     avRGB = [255 0 0]; <span class="comment">% red</span>
0143     isAVOpaque = 1;
0144     
0145     <span class="comment">% Construct the video file.</span>
0146     <span class="keyword">if</span> ispc()
0147         avw = videoWriter(anglesVideoFile, <span class="string">'fps'</span>, fps, <span class="string">'plugin'</span>, <span class="keyword">...</span>
0148             <span class="string">'DirectShow'</span>);
0149     <span class="keyword">else</span>
0150         avw = videoWriter(anglesVideoFile, <span class="string">'fps'</span>, fps, <span class="string">'plugin'</span>, <span class="keyword">...</span>
0151             <span class="string">'ffmpegDirect'</span>);
0152     <span class="keyword">end</span>
0153 <span class="keyword">end</span>
0154 
0155 <span class="comment">% Are we making a video showing the worm's touching segments?</span>
0156 <span class="keyword">if</span> ~isempty(touchVideoFile)
0157     isVideo = true;
0158 
0159     <span class="comment">% Choose the color scheme.</span>
0160     thRGB = [150 150 64];
0161     isTHOpaque = 1;
0162     ttRGB = [64 64 0];
0163     isTTOpaque = 1;
0164     tvRGB = [96 96 255];
0165     isTVOpaque = 1;
0166     tnvRGB = [0 0 224];
0167     isTNVOpaque = 1;
0168     tcTouchRGB = [255 255 255];
0169     isTCTOpaque = 1;
0170     tcInRGB = [255 0 0];
0171     isTCIOpaque = 1;
0172     tcOutRGB = [0 255 0];
0173     isTCOOpaque = 1;
0174     tsTouchRGB = [255 255 255];
0175     isTSTOpaque = 1;
0176     tsInRGB = [0 255 0];
0177     isTSIOpaque = 1;
0178     tsOutRGB = [255 0 0];
0179     isTSOOpaque = 1;
0180     tsInOutRGB = [255 150 255];
0181     isTSIOOpaque = 1;
0182     
0183     <span class="comment">% Construct the video file.</span>
0184     <span class="keyword">if</span> ispc()
0185         tvw = videoWriter(touchVideoFile, <span class="string">'fps'</span>, fps, <span class="string">'plugin'</span>, <span class="keyword">...</span>
0186             <span class="string">'DirectShow'</span>);
0187     <span class="keyword">else</span>
0188         tvw = videoWriter(touchVideoFile, <span class="string">'fps'</span>, fps, <span class="string">'plugin'</span>, <span class="keyword">...</span>
0189             <span class="string">'ffmpegDirect'</span>);
0190     <span class="keyword">end</span>
0191 <span class="keyword">end</span>
0192 
0193 <span class="comment">% Are we making a video to debug worm segmentation?</span>
0194 <span class="keyword">if</span> ~isempty(debugVideoFile)
0195     isVideo = true;
0196     
0197     <span class="comment">% Construct the video file.</span>
0198     <span class="keyword">if</span> ispc()
0199         dvw = videoWriter(debugVideoFile, <span class="string">'plugin'</span>, <span class="string">'DirectShow'</span>, <span class="keyword">...</span>
0200             <span class="string">'fps'</span>, fps, <span class="string">'fourcc'</span>, <span class="string">'FFDS'</span>);
0201     <span class="keyword">else</span>
0202         dvw = videoWriter(debugVideoFile, <span class="string">'plugin'</span>, <span class="string">'ffmpegDirect'</span>, <span class="keyword">...</span>
0203             <span class="string">'fps'</span>, fps, <span class="string">'fourcc'</span>, <span class="string">'FFDS'</span>);
0204     <span class="keyword">end</span>
0205 <span class="keyword">end</span>
0206 
0207 <span class="comment">% Is the video grayscale?</span>
0208 <span class="comment">% Note: if there's no difference between the red and green channel, we</span>
0209 <span class="comment">% consider all 3 RGB channels identical grayscale images.</span>
0210 isGray = false;
0211 isVideoFrame = next(vr);
0212 <span class="keyword">if</span> isVideoFrame
0213     img = getframe(vr);
0214     <span class="keyword">if</span> max(max(abs(img(:,:,1) - img(:,:,2)))) == 0
0215         isGray = true;
0216     <span class="keyword">end</span>
0217 <span class="keyword">end</span>
0218 
0219 <span class="comment">% Pre-compute the values for orienting successive worm frames.</span>
0220 prevOrientWorm = [];
0221 orientSamples = [1:5 7:11] / 12;
0222 
0223 <span class="comment">% Compute the time boundaries for small head movements.</span>
0224 <span class="comment">% Note: at around, 1/30 of a second, worm movements are dwarfed by camera</span>
0225 <span class="comment">% noise. On the other hand, small worm head movements can complete in just</span>
0226 <span class="comment">% under 1/6 of a second. Therefore, when evaluating the head and tail</span>
0227 <span class="comment">% movement confidences, we attempt to differentiate at 1/6 of a second.</span>
0228 <span class="comment">% Unfortunately, due to dropped frames, stage movement, and failed</span>
0229 <span class="comment">% segmentation, the requisite frame for differentiation may be missing.</span>
0230 <span class="comment">% Therefore, we set an upper bound of 1/4 of a second (1.5 * 1/6) so as at</span>
0231 <span class="comment">% to catch any small head movements without the possibility that the head</span>
0232 <span class="comment">% returned to its initial location.</span>
0233 htMoveMinDiff = round(fps / 6) - 1;
0234 htMoveMaxDiff = round(fps / 4) - 1;
0235 prevWorms = cell(htMoveMaxDiff,1);
0236 
0237 <span class="comment">% Pre-allocate memory for the color, movement, and proximity confidences.</span>
0238 failedFrames(1:frames) = NaN; 
0239 hOrthoConfidence = zeros(frames, 1); <span class="comment">% head orthogonal movement confidences</span>
0240 tOrthoConfidence = zeros(frames, 1); <span class="comment">% tail orthogonal movement confidences</span>
0241 hParaConfidence = zeros(frames, 1); <span class="comment">% head parallel movement confidences</span>
0242 tParaConfidence = zeros(frames, 1); <span class="comment">% tail parallel movement confidences</span>
0243 hMagConfidence = zeros(frames, 1); <span class="comment">% head movement magnitude confidences</span>
0244 tMagConfidence = zeros(frames, 1); <span class="comment">% tail movement magnitude confidences</span>
0245 hColorConfidence = zeros(frames, 1); <span class="comment">% head color confidences</span>
0246 tColorConfidence = zeros(frames, 1); <span class="comment">% tail color confidences</span>
0247 vColorConfidence = zeros(frames, 1); <span class="comment">% vulva-side color confidences</span>
0248 nvColorConfidence = zeros(frames, 1); <span class="comment">% non-vulval-side color confidences</span>
0249 proximityConfidence = zeros(frames, 1); <span class="comment">% proximity confidences</span>
0250 flippedConfidence = zeros(frames, 1); <span class="comment">% flipped confidences</span>
0251 
0252 <span class="comment">% Measure the video frame statistics.</span>
0253 totalSegmentedFrames = 0;
0254 totalUnsegmentedFrames = 0;
0255 totalDroppedFrames = 0;
0256 
0257 <span class="comment">% Segment the video.</span>
0258 prevTimestamp = -spf;
0259 <span class="comment">%j = 1; % frame index</span>
0260 k = 1; <span class="comment">% proximity confidences index</span>
0261 l = 1; <span class="comment">% head and tail movement confidences index</span>
0262 m = 1; <span class="comment">% color and movement confidences index</span>
0263 <span class="keyword">while</span> isVideoFrame <span class="comment">%&amp;&amp; j &lt;= 1000</span>
0264     <span class="comment">%j = j + 1;</span>
0265     
0266     <span class="comment">% Get the video frame and convert it to grayscale.</span>
0267     <span class="keyword">if</span> isGray
0268         img = getframe(vr);
0269         img = img(:,:,1);
0270     <span class="keyword">else</span>
0271         img = rgb2gray(getframe(vr));
0272     <span class="keyword">end</span>
0273     
0274     <span class="comment">% Correct the vignette.</span>
0275     <span class="keyword">if</span> ~isempty(vImg)
0276         img = uint8(single(img) - single(vImg));
0277     <span class="keyword">end</span>
0278     
0279     <span class="comment">% Check for dropped frames.</span>
0280     timestamp = get(vr, <span class="string">'timeStamp'</span>);
0281     frame = round(timestamp * fps);
0282     droppedFrames = round((timestamp - prevTimestamp) * fps - 1);
0283     totalDroppedFrames = totalDroppedFrames + droppedFrames;
0284     prevTimestamp = timestamp;
0285     
0286     <span class="comment">% Fill in the dropped frames.</span>
0287     <span class="keyword">if</span> droppedFrames &gt;= 1
0288     
0289         <span class="comment">% Update the previous worms</span>
0290         <span class="keyword">if</span> droppedFrames &lt; length(prevWorms)
0291             <span class="keyword">for</span> i = (frame - droppedFrames):(frame - 1)
0292                 prevWorms{mod(i, length(prevWorms)) + 1} = [];
0293             <span class="keyword">end</span>
0294         <span class="keyword">else</span>
0295             <span class="keyword">for</span> i = 1:length(prevWorms)
0296                 prevWorms{i} = [];
0297             <span class="keyword">end</span>
0298         <span class="keyword">end</span>
0299         
0300         <span class="comment">% Fill in the video.</span>
0301         <span class="keyword">if</span> isVideo
0302             <span class="keyword">if</span> ~isempty(anglesVideoFile) || ~isempty(touchVideoFile)
0303                 dropImg = <a href="overlayBadWorm.html" class="code" title="function oImg = overlayBadWorm(img, type)">overlayBadWorm</a>(img, <span class="string">'d'</span>);
0304             <span class="keyword">end</span>
0305             <span class="keyword">if</span> ~isempty(anglesVideoFile)
0306                 <span class="keyword">for</span> i = 1:droppedFrames
0307                     addframe(avw, dropImg);
0308                 <span class="keyword">end</span>
0309             <span class="keyword">end</span>
0310             <span class="keyword">if</span> ~isempty(touchVideoFile)
0311                 <span class="keyword">for</span> i = 1:droppedFrames
0312                     addframe(tvw, dropImg);
0313                 <span class="keyword">end</span>
0314             <span class="keyword">end</span>
0315             <span class="keyword">if</span> ~isempty(debugVideoFile)
0316                 <span class="keyword">for</span> i = 1:droppedFrames
0317                     addframe(dvw, debugImg);
0318                 <span class="keyword">end</span>
0319             <span class="keyword">end</span>
0320         <span class="keyword">end</span>
0321     <span class="keyword">end</span>
0322     
0323 <span class="comment">%     % Code for debugging.</span>
0324 <span class="comment">%     disp(['Frame = ' num2str(get(vr, 'approxFrameNum')) ...</span>
0325 <span class="comment">%         ', real frame = '  num2str(timestamp / spf) ...</span>
0326 <span class="comment">%         ', timestamp = ' num2str(timestamp)]);</span>
0327     
0328     <span class="comment">% The stage is moving.</span>
0329     <span class="keyword">if</span> ~isempty(moveFrames) &amp;&amp; moveFrames(frame + 1)
0330         prevWorms{mod(frame, length(prevWorms)) + 1} = [];
0331     
0332     <span class="comment">% Segment the video frame.</span>
0333     <span class="keyword">else</span>
0334         worm = <a href="../../../SegWorm/Worms/Segmentation/segWorm.html" class="code" title="function worm = segWorm(img, frame, isNormalized, verbose, varargin)">segWorm</a>(img, frame, true, ~isempty(debugVideoFile));
0335         
0336         <span class="comment">% Segmentation failed.</span>
0337         <span class="keyword">if</span> isempty(worm)
0338             totalUnsegmentedFrames = totalUnsegmentedFrames + 1;
0339             failedFrames(totalUnsegmentedFrames) = frame;
0340             prevWorms{mod(frame, length(prevWorms)) + 1} = [];
0341 
0342         <span class="comment">% Orient and downsample the worm.</span>
0343         <span class="keyword">else</span>
0344             
0345             <span class="comment">% Determine the worm orientation.</span>
0346             <span class="keyword">if</span> isempty(prevOrientWorm)
0347                 
0348                 <span class="comment">% The frame segmented.</span>
0349                 totalSegmentedFrames = totalSegmentedFrames + 1;
0350 
0351                 <span class="comment">% Are the head and tail flipped?</span>
0352                 hColorConfidence(m) = <span class="keyword">...</span>
0353                     worm.orientation.head.confidence.head;
0354                 tColorConfidence(m) = <span class="keyword">...</span>
0355                     worm.orientation.head.confidence.tail;
0356                 <span class="keyword">if</span> hColorConfidence(m) &lt; tColorConfidence(m)
0357                     worm = <a href="../../../SegWorm/Worms/Orientation/flipWormHead.html" class="code" title="function worm = flipWormHead(worm)">flipWormHead</a>(worm);
0358                     hColorConfidence(m) = <span class="keyword">...</span>
0359                         worm.orientation.head.confidence.head;
0360                     tColorConfidence(m) = <span class="keyword">...</span>
0361                         worm.orientation.head.confidence.tail;
0362                 <span class="keyword">end</span>
0363                 
0364                 <span class="comment">% Where is the vulva?</span>
0365                 vColorConfidence(m) = <span class="keyword">...</span>
0366                     worm.orientation.vulva.confidence.vulva;
0367                 nvColorConfidence(m) = <span class="keyword">...</span>
0368                     worm.orientation.vulva.confidence.nonVulva;
0369                 <span class="keyword">if</span> vColorConfidence(m) &lt; nvColorConfidence(m)
0370                     worm = <a href="../../../SegWorm/Worms/Orientation/flipWormVulva.html" class="code" title="function worm = flipWormVulva(worm)">flipWormVulva</a>(worm);
0371                     vColorConfidence(m) = <span class="keyword">...</span>
0372                         worm.orientation.vulva.confidence.vulva;
0373                     nvColorConfidence(m) = <span class="keyword">...</span>
0374                         worm.orientation.vulva.confidence.nonVulva;
0375                 <span class="keyword">end</span>
0376                 m = m + 1;
0377                 
0378                 <span class="comment">% Advance.</span>
0379                 prevOrientWorm = worm;
0380                 prevWorms{mod(frame, length(prevWorms)) + 1} = worm;
0381                 
0382             <span class="comment">% Orient the worm relative to the nearest segmented frame.</span>
0383             <span class="keyword">else</span>
0384                 
0385                 <span class="comment">% The frame segmented.</span>
0386                 totalSegmentedFrames = totalSegmentedFrames + 1;
0387                 
0388                 <span class="comment">% Orient the worm and record its orientation confidences.</span>
0389                 <span class="keyword">if</span> ~isempty(moveFrames) &amp;&amp; moveFrames(frame)
0390                     [worm, proximityConfidence(k), flippedConfidence(k)] = <span class="keyword">...</span>
0391                         <a href="../../../SegWorm/Worms/Orientation/orientWormAtCentroid.html" class="code" title="function [worm2 confidence flippedConfidence] =orientWormAtCentroid(worm1, worm2, samples, varargin)">orientWormAtCentroid</a>(prevOrientWorm, worm, <span class="keyword">...</span>
0392                         orientSamples);
0393                 <span class="keyword">else</span> <span class="comment">% the previous frame was not a stage movement</span>
0394                     [worm, proximityConfidence(k), flippedConfidence(k)] = <span class="keyword">...</span>
0395                         <a href="../../../SegWorm/Worms/Orientation/orientWorm.html" class="code" title="function [worm2 confidence flippedConfidence] =orientWorm(worm1, worm2, samples, varargin)">orientWorm</a>(prevOrientWorm, worm, orientSamples);
0396                 <span class="keyword">end</span>
0397                 k = k + 1;
0398                 
0399                 <span class="comment">% Record the head and tail movement confidences.</span>
0400                 <span class="keyword">if</span> htMoveMinDiff &lt;= frame
0401                     
0402                     <span class="comment">% Find the nearest previous differentiable worm.</span>
0403                     i = htMoveMinDiff;
0404                     prevWormsI = mod(frame - i, length(prevWorms)) + 1;
0405                     prevFrame = frame - 1;
0406                     <span class="keyword">while</span> i &lt; prevFrame &amp;&amp; i &lt; htMoveMaxDiff &amp;&amp; <span class="keyword">...</span>
0407                             isempty(prevWorms{prevWormsI})
0408                         i = i + 1;
0409                         prevWormsI = mod(frame - i, length(prevWorms)) + 1;
0410                     <span class="keyword">end</span>
0411                     
0412                     <span class="comment">% Record the head and tail movement confidences.</span>
0413                     <span class="keyword">if</span> ~isempty(prevWorms{prevWormsI})
0414                         [hOrthoConfidence(l) tOrthoConfidence(l) <span class="keyword">...</span>
0415                             hParaConfidence(l) tParaConfidence(l) <span class="keyword">...</span>
0416                             hMagConfidence(l) tMagConfidence(l)] = <span class="keyword">...</span>
0417                             <a href="../../../SegWorm/Worms/Orientation/headTailMovementConfidence.html" class="code" title="function [headOrthoConfidence tailOrthoConfidenceheadParaConfidence tailParaConfidenceheadMagConfidence tailMagConfidence] =headTailMovementConfidence(worm1, worm2, varargin)">headTailMovementConfidence</a>( <span class="keyword">...</span>
0418                             prevWorms{prevWormsI}, worm);
0419 <span class="comment">%                         if hOrthoConfidence(l) &lt; tOrthoConfidence(l)</span>
0420 <span class="comment">%                             worm = flipWormHead(worm);</span>
0421 <span class="comment">%                         end</span>
0422 <span class="comment">%                         if hParaConfidence(l) &lt; tParaConfidence(l)</span>
0423 <span class="comment">%                             worm = flipWormHead(worm);</span>
0424 <span class="comment">%                         end</span>
0425 <span class="comment">%                         if hMagConfidence(l) &lt; tMagConfidence(l)</span>
0426 <span class="comment">%                             worm = flipWormHead(worm);</span>
0427 <span class="comment">%                         end</span>
0428                         l = l + 1;
0429                     <span class="keyword">end</span>
0430                 <span class="keyword">end</span>
0431                 
0432                 <span class="comment">% Record the coloration confidences.</span>
0433                 hColorConfidence(m) = <span class="keyword">...</span>
0434                     worm.orientation.head.confidence.head;
0435                 tColorConfidence(m) = <span class="keyword">...</span>
0436                     worm.orientation.head.confidence.tail;
0437                 vColorConfidence(m) = <span class="keyword">...</span>
0438                     worm.orientation.vulva.confidence.vulva;
0439                 nvColorConfidence(m) = <span class="keyword">...</span>
0440                     worm.orientation.vulva.confidence.nonVulva;
0441                 m = m + 1;
0442                 
0443                 <span class="comment">% Advance.</span>
0444                 prevOrientWorm = worm;
0445                 prevWorms{mod(frame, length(prevWorms)) + 1} = worm;
0446             <span class="keyword">end</span>
0447             
0448             <span class="comment">% Downsample the worm.</span>
0449             <span class="keyword">if</span> ~isempty(downSamples)
0450                 
0451                 <span class="comment">% Normalize the worm.</span>
0452                 [vulvaContour nonVulvaContour skeleton skeletonAngles <span class="keyword">...</span>
0453                     inOutTouch skeletonLength widths headArea tailArea <span class="keyword">...</span>
0454                     vulvaArea nonVulvaArea] = <a href="../../../SegWorm/Worms/Util/normWorms.html" class="code" title="function [vulvaContours nonVulvaContours skeletons angles inOutToucheslengths widths headAreas tailAreas vulvaAreas nonVulvaAreas isNormed] =normWorms(worms, samples, moves, origins, pixel2MicronScale,rotation, verbose)">normWorms</a>({worm}, <span class="keyword">...</span>
0455                     downSamples, origins, moves, pixel2MicronScale, <span class="keyword">...</span>
0456                     rotation, false);
0457                 <span class="keyword">if</span> isInterp
0458                     worm = [];
0459                 <span class="keyword">end</span>
0460                 
0461                 <span class="comment">% Reconstruct the normalized worm.</span>
0462                 worm = <a href="../../../SegWorm/Worms/Util/norm2Worm.html" class="code" title="function worm = norm2Worm(frame, vulvaContour, nonVulvaContour,skeleton, skeletonAngles, inOutTouch, skeletonLength, widths,headArea, tailArea, vulvaArea, nonVulvaArea,origin, pixel2MicronScale, rotation, worm)">norm2Worm</a>(frame, vulvaContour, nonVulvaContour, <span class="keyword">...</span>
0463                     skeleton, skeletonAngles, inOutTouch, <span class="keyword">...</span>
0464                     skeletonLength, widths, <span class="keyword">...</span>
0465                     headArea, tailArea, vulvaArea, nonVulvaArea, <span class="keyword">...</span>
0466                     origins, pixel2MicronScale, rotation, worm);
0467             <span class="keyword">end</span>
0468         <span class="keyword">end</span>
0469     <span class="keyword">end</span>
0470     
0471     <span class="comment">% Are we making a video?</span>
0472     <span class="keyword">if</span> isVideo
0473 
0474         <span class="comment">% Convert the image to 8-bit grayscale.</span>
0475         <span class="keyword">if</span> isfloat(img)
0476             img = uint8(round(img * 255));
0477         <span class="keyword">end</span>
0478         
0479         <span class="comment">% Are we showing the worm's angles or touching segments?</span>
0480         isSeg = true;
0481         <span class="keyword">if</span>  ~isempty(anglesVideoFile) || ~isempty(touchVideoFile)
0482             
0483             <span class="comment">% Overlay the stage movement.</span>
0484             <span class="keyword">if</span> ~isempty(moveFrames) &amp;&amp; moveFrames(frame + 1)
0485                 segImg = <a href="overlayBadWorm.html" class="code" title="function oImg = overlayBadWorm(img, type)">overlayBadWorm</a>(img, <span class="string">'m'</span>);
0486                 isSeg = false;
0487                 
0488             <span class="comment">% Overlay the bad worm.</span>
0489             <span class="keyword">elseif</span> isempty(worm)
0490                 segImg = <a href="overlayBadWorm.html" class="code" title="function oImg = overlayBadWorm(img, type)">overlayBadWorm</a>(img, <span class="string">'f'</span>);
0491                 isSeg = false;
0492             <span class="keyword">end</span>
0493         <span class="keyword">end</span>
0494         
0495         <span class="comment">% Show the worm's angles.</span>
0496         <span class="keyword">if</span> ~isempty(anglesVideoFile)
0497             <span class="keyword">if</span> isSeg
0498                 segImg = <a href="overlayWormAngles.html" class="code" title="function oImg = overlayWormAngles(img, worm, cRGB360, sRGB360, sRGBNaN,headPattern, headRGB, isHeadOpaque, vulvaPattern, vulvaRGB, isVulvaOpaque)">overlayWormAngles</a>(img, worm, acRGB, <span class="keyword">...</span>
0499                     asRGB, asRGBNaN, ahPattern, ahRGB, isAHOpaque, <span class="keyword">...</span>
0500                     avPattern, avRGB, isAVOpaque);
0501             <span class="keyword">end</span>
0502             addframe(avw, segImg);
0503         <span class="keyword">end</span>
0504         
0505         <span class="comment">% Show the worm's touching segments.</span>
0506         <span class="keyword">if</span> ~isempty(touchVideoFile)
0507             <span class="keyword">if</span> isSeg
0508                 segImg = <a href="overlayWormTouch.html" class="code" title="function oImg = overlayWormTouch(img, worm, headRGB, isHeadOpaque,tailRGB, isTailOpaque, vulvaRGB, isVulvaOpaque, nonVulvaRGB, isNonVulvaOpaque,cTouchRGB, isCTouchOpaque, cInRGB, isCInOpaque, cOutRGB, isCOutOpaque,sTouchRGB, isSTouchOpaque, sInRGB, isSInOpaque, sOutRGB, isSOutOpaque,sInOutRGB, isSInOutOpaque)">overlayWormTouch</a>(img, worm, thRGB, isTHOpaque, <span class="keyword">...</span>
0509                     ttRGB, isTTOpaque, tvRGB, isTVOpaque, <span class="keyword">...</span>
0510                     tnvRGB, isTNVOpaque, tcTouchRGB, isTCTOpaque, <span class="keyword">...</span>
0511                     tcInRGB, isTCIOpaque, tcOutRGB, isTCOOpaque, <span class="keyword">...</span>
0512                     tsTouchRGB, isTSTOpaque, tsInRGB, isTSIOpaque, <span class="keyword">...</span>
0513                     tsOutRGB, isTSOOpaque, tsInOutRGB, isTSIOOpaque);
0514             <span class="keyword">end</span>
0515             addframe(tvw, segImg);
0516         <span class="keyword">end</span>
0517         
0518         <span class="comment">% Show the debugging information.</span>
0519         <span class="keyword">if</span> ~isempty(debugVideoFile)
0520             debugImg = frame2im(getframe(gcf));
0521             close(gcf);
0522             addframe(dvw, debugImg);
0523         <span class="keyword">end</span>
0524     <span class="keyword">end</span>
0525     
0526     <span class="comment">% Advance to the next video frame.</span>
0527     isVideoFrame = next(vr);
0528 <span class="keyword">end</span>
0529 
0530 <span class="comment">% Clean up the videos and failed frames.</span>
0531 close(vr);
0532 <span class="keyword">if</span> ~isempty(anglesVideoFile)
0533     close(avw);
0534 <span class="keyword">end</span>
0535 <span class="keyword">if</span> ~isempty(touchVideoFile)
0536     close(tvw);
0537 <span class="keyword">end</span>
0538 <span class="keyword">if</span> ~isempty(debugVideoFile)
0539     close(dvw);
0540 <span class="keyword">end</span>
0541 failedFrames((totalUnsegmentedFrames + 1):end) = [];
0542 
0543 <span class="comment">% Clean up the color, movement, and proximity confidences.</span>
0544 proximityConfidence(k:end) = [];
0545 flippedConfidence(k:end) = [];
0546 hOrthoConfidence(l:end) = [];
0547 tOrthoConfidence(l:end) = [];
0548 hParaConfidence(l:end) = [];
0549 tParaConfidence(l:end) = [];
0550 hMagConfidence(l:end) = [];
0551 tMagConfidence(l:end) = [];
0552 hColorConfidence(m:end) = [];
0553 tColorConfidence(m:end) = [];
0554 vColorConfidence(m:end) = [];
0555 nvColorConfidence(m:end) = [];
0556 
0557 <span class="comment">% Report the color, movement, and proximity confidences.</span>
0558 disp(<span class="string">'Mean confidence:'</span>);
0559 disp([<span class="string">'Head ortho-movement     = '</span> num2str(mean(hOrthoConfidence))]);
0560 disp([<span class="string">'Tail ortho-movement     = '</span> num2str(mean(tOrthoConfidence))]);
0561 disp([<span class="string">'Head para-movement      = '</span> num2str(mean(hParaConfidence))]);
0562 disp([<span class="string">'Tail para-movement      = '</span> num2str(mean(tParaConfidence))]);
0563 disp([<span class="string">'Head movement magnitude = '</span> num2str(mean(hMagConfidence))]);
0564 disp([<span class="string">'Tail movement magnitude = '</span> num2str(mean(tMagConfidence))]);
0565 disp([<span class="string">'Head color      = '</span> num2str(mean(hColorConfidence))]);
0566 disp([<span class="string">'Tail color      = '</span> num2str(mean(tColorConfidence))]);
0567 disp([<span class="string">'Vulva color     = '</span> num2str(mean(vColorConfidence))]);
0568 disp([<span class="string">'Non-vulva color = '</span> num2str(mean(nvColorConfidence))]);
0569 disp([<span class="string">'Proximity confidence = '</span> num2str(mean(proximityConfidence))]);
0570 disp([<span class="string">'Flipped confidence   = '</span> num2str(mean(flippedConfidence))]);
0571 [~, minI] = min(proximityConfidence ./ flippedConfidence);
0572 disp([<span class="string">'Minimum confidence   = '</span> num2str(proximityConfidence(minI)) <span class="keyword">...</span>
0573     <span class="string">' proximal vs. '</span> num2str(flippedConfidence(minI)) <span class="string">' flipped'</span>]);
0574 
0575 <span class="comment">% Report the video frame statistics.</span>
0576 <span class="keyword">if</span> isempty(moveFrames)
0577     totalMoveFrames = 0;
0578 <span class="keyword">else</span>
0579     totalMoveFrames = sum(moveFrames);
0580 <span class="keyword">end</span>
0581 disp([10 <span class="string">'***'</span> 10 10 <span class="string">'Video frame statistics:'</span>]);
0582 disp([<span class="string">'Segmented frames      = '</span> num2str(totalSegmentedFrames)]);
0583 disp([<span class="string">'Unsegmented frames    = '</span> num2str(totalUnsegmentedFrames)]);
0584 disp([<span class="string">'Stage movement frames = '</span> num2str(totalMoveFrames)]);
0585 disp([<span class="string">'Dropped frames        = '</span> num2str(totalDroppedFrames)]);
0586 disp([<span class="string">'Total frames          = '</span> num2str(totalSegmentedFrames + <span class="keyword">...</span>
0587     totalUnsegmentedFrames + totalDroppedFrames + totalMoveFrames)]);
0588 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 25-Jun-2013 14:47:30 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>